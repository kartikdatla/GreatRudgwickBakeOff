# Great Rudgwick Bake Off - Project Context

## Overview
Full-stack baking competition app. Bakers submit photos, judges score them, admins manage themes.
- **Live URL:** https://bakeoff.kartik.uk
- **Server:** Hetzner VPS (46.225.217.92), Ubuntu 24.04
- **Domain:** kartik.uk registered at Porkbun. `bakeoff` A record -> Hetzner IP.

## Tech Stack
- **Backend:** Express.js, SQLite3, JWT auth, bcryptjs, Multer (image uploads)
- **Frontend:** React 18, Vite, Tailwind CSS, React Router v6, Axios
- **Deploy:** Nginx reverse proxy -> Express on port 5001, PM2 process manager, Let's Encrypt SSL

## Project Structure
```
backend/
  src/
    config/       # database.js, multer.js, initDatabase.js
    controllers/  # authController, themeController, submissionController, scoreController, resourceController
    middleware/   # auth.js (JWT verify + role-based authorizeRoles)
    models/       # User.js (User + InviteCode), Theme.js (Theme + MainTheme), Submission.js, Score.js, Resource.js, Settings.js
    routes/       # auth, themes, submissions, scores, resources, admin
    scripts/      # createAdmin.js, createAdminAuto.js
    utils/        # tokenUtils.js, colorValidation.js
    server.js     # Express entry point
  uploads/        # User-submitted images (UUID filenames)
  .env            # PORT, JWT_SECRET, JWT_EXPIRES_IN, NODE_ENV
frontend/
  src/
    pages/        # Dashboard, Login, Register, SubmitEntry, Submissions, Judging, Leaderboard, Resources, ThemeDraw, ThemeManagement, AdminPanel, UserManagement
    components/   # Layout, BackgroundAnimation, PrivateRoute
    context/      # AuthContext, ThemeContext
    services/     # api.js (Axios with token handling)
    utils/        # videoEmbed.js (YouTube/Vimeo URL conversion)
deploy/
  setup.sh        # Full server setup script
  nginx-bakeoff.conf
```

## Database Tables (SQLite)
1. **users** - id, email (UNIQUE), password (bcrypt), name, role (Baker|Judge|Spectator|Admin), is_active
2. **main_themes** - Baking categories: Cakes, Biscuits, Breads, Pastries, Traybakes, Small Bakes
3. **themes** - Monthly active theme with main_theme_id + sub_theme_id + intro_video_url. UNIQUE(month, year)
4. **theme_pool** - 12 sub-themes with color schemes (primary, secondary, accent, gradient). Tracks is_used
5. **submissions** - user_id, theme_id, title, description, image_path. UNIQUE(user_id, theme_id)
6. **scores** - submission_id, judge_id, taste/presentation/creativity/overall (1-10), comments. UNIQUE(submission_id, judge_id)
7. **resources** - Links to baking supplies by category (Boxes, Decorations, Ingredients, Tools, Other)
8. **settings** - Key-value store. Key: scores_revealed (true/false)
9. **invite_codes** - code (UNIQUE), role, max_uses, uses, is_active

## Two-Tier Theme System
- **Main Theme** (public): What to bake - visible to all users (e.g., "Cakes")
- **Sub-Theme** (secret): Judging criteria - hidden until admin reveals (e.g., "Chocolate Paradise")
- Sub-themes include color schemes that dynamically theme the entire UI
- Admin can reveal sub-theme to judges independently

## Key API Endpoints
```
POST   /api/auth/register              # Requires invite code
POST   /api/auth/login                 # Returns JWT token
GET    /api/themes/active              # Returns theme (sub-theme hidden based on role)
POST   /api/themes/draw                # Admin: random draw
DELETE /api/themes/:id                 # Admin: delete theme (returns sub-theme to pool)
PATCH  /api/themes/:id/intro-video     # Admin: set YouTube/Vimeo URL
PATCH  /api/themes/:id/reveal          # Admin: reveal sub-theme to judges
POST   /api/submissions                # Baker: upload entry (multipart/form-data)
POST   /api/scores/submission/:id      # Judge: submit scores
GET    /api/scores/leaderboard/:id     # Ranked submissions with averages
POST   /api/admin/invites              # Admin: generate invite code
```

## Auth & Roles
- **Registration** requires a valid invite code (generated by admin). Role assigned from code.
- **JWT** token in Authorization header. Payload: id, email, name, role. Expires 7d.
- **Baker**: Submit entries, view themes/leaderboards
- **Judge**: Score submissions, view sub-theme (when revealed), manage resources
- **Spectator**: View-only access
- **Admin**: Full control. Cannot modify own role or deactivate self.

## Critical Implementation Notes

### Dotenv Loading
Dotenv MUST use explicit path. PM2 changes cwd, breaking default dotenv behavior:
```javascript
const path = require('path');
require('dotenv').config({ path: path.join(__dirname, '../.env') });
```
All scripts (server.js, createAdmin.js, etc.) use this pattern.

### Image Uploads
- Multer saves to `backend/uploads/` with UUID filenames
- Allowed: JPEG, JPG, PNG, GIF, WebP. Max 5MB.
- Served via `express.static` at `/uploads`
- Path stored in DB as `/uploads/{uuid}.{ext}`

### Invite Codes
- Generated as 8-char uppercase hex (crypto.randomBytes(4))
- Input trimmed + uppercased before DB lookup
- Codes have max_uses and track usage count

### Intro Videos
- Admin pastes YouTube/Vimeo URL on Theme Management page
- Stored as `intro_video_url` on themes table
- Frontend converts to embed URL with autoplay=1&mute=1
- Displayed on Dashboard above theme card

### Score Visibility
- Controlled by `scores_revealed` setting (default: false)
- When false: judges see only their own scores, leaderboard hidden
- Admin toggles via `/api/scores/reveal`

## Deployment Commands

### Deploy updates from Mac:
```bash
cd ~/GreatRudgwickBakeOff
git add . && git commit -m "feat: description" && git push
```

### On Hetzner server (ssh root@46.225.217.92):
```bash
cd /var/www/bakeoff && git pull origin main
cd frontend && npm run build && cd ..
pm2 restart bakeoff
```

### If database schema changed:
```bash
cd /var/www/bakeoff && node backend/src/config/initDatabase.js
pm2 restart bakeoff
```

### PM2 commands:
```bash
pm2 list                    # Check status
pm2 logs bakeoff --lines 30 # View logs
pm2 restart bakeoff         # Restart app
pm2 delete bakeoff          # Remove process
# Start with explicit env vars:
NODE_ENV=production PORT=5001 pm2 start backend/src/server.js --name bakeoff
pm2 save                    # Persist process list
```

### Check SSL cert:
```bash
sudo certbot certificates
sudo certbot renew --dry-run
```

## Troubleshooting

### "secretOrPrivateKey must have a value"
The JWT_SECRET isn't being read from .env. Ensure `backend/.env` exists on the server with `JWT_SECRET=...` and that dotenv uses explicit path in server.js.

### 502 Bad Gateway
Express isn't running on port 5001. Check `pm2 list` and `pm2 logs bakeoff`. If port shows 5000, the .env isn't being loaded.

### Default nginx page showing
Remove default site: `sudo rm /etc/nginx/sites-enabled/default && sudo nginx -t && sudo systemctl reload nginx`

### Empty git clone on server
Code wasn't pushed. Run `git push -u origin main` from Mac first.

### Invalid invite code
1. Check you're on the production site, not localhost
2. Invite codes must be generated on the same site where registration happens (separate databases)
3. Whitespace is auto-trimmed, case is auto-uppercased

### Admin login credentials
Created via: `node backend/src/scripts/createAdminAuto.js`
Default: admin@bakeoff.com / admin123

## NPM Scripts
```bash
# Root
npm run dev              # Start both frontend + backend dev servers
npm run build            # Build frontend for production
npm run db:init          # Initialize database schema

# Backend
cd backend && npm run dev       # Nodemon dev server
cd backend && npm run migrate   # Run all migrations

# Frontend
cd frontend && npm run dev      # Vite dev server (port 3000)
cd frontend && npm run build    # Production build -> dist/
```

## .gitignore Excludes
node_modules, .env, .env.local, .env.production, *.sqlite, *.db, backend/uploads/*, dist/, .DS_Store
